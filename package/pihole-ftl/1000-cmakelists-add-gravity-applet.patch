Upstream: not sent

Signed-off-by: Andreas Ziegler <br015@umbiko.net>
--- a/src/CMakeLists.txt
+++ b/src/CMakeLists.txt
@@ -221,6 +221,12 @@
 set(CMAKE_C_FLAGS_RELEASE "-O3 -DNDEBUG -funroll-loops")
 set(CMAKE_C_FLAGS_RELWITHDEBINFO "${CMAKE_C_FLAGS_RELEASE} -g3")
 set(CMAKE_C_FLAGS_MINSIZEREL "-Os -DNDEBUG")
+
+option(GRAVITY "Include gravity update functionality in build")
+
+if(GRAVITY)
+    set(gravity_files gravity.c gravity.h)
+endif()
 
 set(sources
         args.c
@@ -268,6 +274,7 @@
         vector.h
         version.c
         version.h
+        ${gravity_files}
         )
 
 # version.c is generated by gen_version.cmake
@@ -313,11 +320,27 @@
 else()
     find_library(LIBMATH m)
     target_link_libraries(pihole-FTL ${LIBMATH})
-    set(LIBRARY_SUFFIX "")
+    set(LIBRARY_SUFFIX "${CMAKE_SHARED_LIBRARY_SUFFIX}")
 endif()
 set(CMAKE_THREAD_PREFER_PTHREAD TRUE)
 set(THREADS_PREFER_PTHREAD_FLAG TRUE)
 find_package(Threads REQUIRED)
+
+if(GRAVITY)
+    find_package(PkgConfig QUIET)
+    if(PKG_CONFIG_FOUND)
+        pkg_check_modules(PKG_LibCurl QUIET libcurl)
+        pkg_check_modules(PKG_LibCrypto QUIET libcrypto)
+    endif()
+
+    # the gravity module needs libcurl and libcrypto (or libssl)
+    find_library(LIBCURL 
+        NAMES curl libcurl libcurl{LIBRARY_SUFFIX}
+        HINTS ${PKG_LibCurl_LIBRARY_DIRS})
+    find_library(LIBCRYPTO
+        NAMES crypto libcrypto libcrypto{LIBRARY_SUFFIX}
+        HINTS ${PKG_LibCrypto_LIBRARY_DIRS})
+endif()
 
 # for DNSSEC we need the nettle (+ hogweed) crypto and the gmp math libraries
 find_library(LIBHOGWEED NAMES libhogweed${LIBRARY_SUFFIX} hogweed HINTS /usr/local/lib64)
@@ -328,7 +351,7 @@
 find_library(LIBIDN2 NAMES libidn2${LIBRARY_SUFFIX} idn2)
 find_library(LIBUNISTRING NAMES libunistring${LIBRARY_SUFFIX} unistring)
 
-target_link_libraries(pihole-FTL rt Threads::Threads ${LIBHOGWEED} ${LIBGMP} ${LIBNETTLE} ${LIBIDN2} ${LIBUNISTRING})
+target_link_libraries(pihole-FTL rt Threads::Threads ${LIBHOGWEED} ${LIBGMP} ${LIBNETTLE} ${LIBIDN2} ${LIBUNISTRING} ${LIBCURL} ${LIBCRYPTO})
 
 if(LUA_DL STREQUAL "true")
     find_library(LIBDL dl)
